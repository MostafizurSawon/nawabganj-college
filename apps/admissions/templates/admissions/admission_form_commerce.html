{% extends layout_path %}
{% load static %}
{% block title %}HSC Commerce Admission{% endblock %}

{% block content %}
<div class="flex-grow-1">
  <h4 class="fw-bold mb-4">
    <span class="text-muted fw-light">HSC Admission /</span>
    Business Studies
  </h4>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-success alert-dismissible" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="alert alert-warning d-flex align-items-start gap-3 shadow-sm rounded-3 border border-warning border-2 my-3"
       role="alert" style="border-left-width:.6rem;">
    <div class="fs-3 lh-1">⚠️</div>
    <div>
      <p class="mb-0 text-dark fw-bold">
        সকল তথ্য সঠিকভাবে পূরণ করুন । ভুল তথ্য পূরণ করলে এডমিশন বাতিল বলে গণ্য হবে ।
      </p>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data">
    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}
    {% csrf_token %}

    <div class="text-center mb-4">
      <button type="submit" class="btn btn-primary">Submit Admission</button>
    </div>

    <!-- College Info -->
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">College Info</h5></div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label for="id_add_session" class="form-label">Session</label>
          {{ form.add_session }}
          {% if form.add_session.errors %}<div class="text-danger small">{{ form.add_session.errors.0 }}</div>{% endif %}
        </div>

        {% if not request.user.role == "student" %}
        <div class="col-md-4">
          <label for="id_add_class_roll" class="form-label">Class Roll</label>
          {{ form.add_class_roll }}
          {% if form.add_class_roll.errors %}<div class="text-danger small">{{ form.add_class_roll.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_class_id" class="form-label">Class ID</label>
          {{ form.add_class_id }}
          {% if form.add_class_id.errors %}<div class="text-danger small">{{ form.add_class_id.errors.0 }}</div>{% endif %}
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Personal -->
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">Personal Information</h5></div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label for="id_add_name" class="form-label">Name (English)</label>
          {{ form.add_name }}
          {% if form.add_name.errors %}<div class="text-danger small">{{ form.add_name.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_mobile" class="form-label">Mobile Number</label>
          {{ form.add_mobile }}
          {% if form.add_mobile.errors %}<div class="text-danger small">{{ form.add_mobile.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_birthdate" class="form-label">Date of Birth</label>
          {{ form.add_birthdate }}
          {% if form.add_birthdate.errors %}<div class="text-danger small">{{ form.add_birthdate.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_age" class="form-label">Age</label>
          {{ form.add_age }}
          {% if form.add_age.errors %}<div class="text-danger small">{{ form.add_age.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_gender" class="form-label">Gender</label>
          {{ form.add_gender }}
          {% if form.add_gender.errors %}<div class="text-danger small">{{ form.add_gender.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_blood_group" class="form-label">Blood Group</label>
          {{ form.add_blood_group }}
          {% if form.add_blood_group.errors %}<div class="text-danger small">{{ form.add_blood_group.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_nationality" class="form-label">Nationality</label>
          {{ form.add_nationality }}
          {% if form.add_nationality.errors %}<div class="text-danger small">{{ form.add_nationality.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_religion" class="form-label">Religion</label>
          {{ form.add_religion }}
          {% if form.add_religion.errors %}<div class="text-danger small">{{ form.add_religion.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_marital_status" class="form-label">Marital Status</label>
          {{ form.add_marital_status }}
          {% if form.add_marital_status.errors %}<div class="text-danger small">{{ form.add_marital_status.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_birth_certificate_no" class="form-label">Birth Certificate No</label>
          {{ form.add_birth_certificate_no }}
          {% if form.add_birth_certificate_no.errors %}<div class="text-danger small">{{ form.add_birth_certificate_no.errors.0 }}</div>{% endif %}
        </div>

        <div class="col-md-8">
          <div class="mb-3">
            <label for="{{ form.add_photo.id_for_label }}" class="form-label fw-bold">
              Upload Photo <span class="text-muted">(Max 500 KB)</span>
            </label>

            {% if student and student.add_photo %}
              <div class="mb-2">
                <img src="{{ student.add_photo.url }}" alt="Current photo"
                     class="rounded border" style="max-height:160px;object-fit:cover">
                <div class="small text-muted">Current photo</div>
              </div>
            {% endif %}

            {{ form.add_photo }}
            {% if form.add_photo.errors %}
              <div class="text-danger small">{{ form.add_photo.errors.0 }}</div>
            {% endif %}

            <div class="form-text text-primary">
              <strong>⚠️ অবশ্যই পাসপোর্ট সাইজের ছবি দিতে হবে এবং ছবির সাইজ ৫০০ কেবির মধ্যে হতে হবে।</strong>
              {% if student and student.add_photo %}
                <br><small>(যদি নতুন ছবি আপলোড না করতে চান, তবে এটি অপরিবর্তিত রাখা হবে।)</small>
              {% endif %}
            </div>
            <div id="photo-size-hint" class="text-danger small mt-1" style="display:none;">
              ⚠️ ফাইলের সাইজ ৫০০ কেবির বেশি। ⚠️
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Parents & Guardian -->
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">Parents & Guardian Information</h5></div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label for="id_add_father" class="form-label">Father's Name</label>
          {{ form.add_father }}
          {% if form.add_father.errors %}<div class="text-danger small">{{ form.add_father.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_father_mobile" class="form-label">Father's Mobile</label>
          {{ form.add_father_mobile }}
          {% if form.add_father_mobile.errors %}<div class="text-danger small">{{ form.add_father_mobile.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_father_nid" class="form-label">Father's NID</label>
          {{ form.add_father_nid }}
          {% if form.add_father_nid.errors %}<div class="text-danger small">{{ form.add_father_nid.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_father_birthdate" class="form-label">Father's Date of Birth</label>
          {{ form.add_father_birthdate }}
          {% if form.add_father_birthdate.errors %}<div class="text-danger small">{{ form.add_father_birthdate.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_mother" class="form-label">Mother's Name</label>
          {{ form.add_mother }}
          {% if form.add_mother.errors %}<div class="text-danger small">{{ form.add_mother.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_mother_mobile" class="form-label">Mother's Mobile</label>
          {{ form.add_mother_mobile }}
          {% if form.add_mother_mobile.errors %}<div class="text-danger small">{{ form.add_mother_mobile.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_mother_nid" class="form-label">Mother's NID</label>
          {{ form.add_mother_nid }}
          {% if form.add_mother_nid.errors %}<div class="text-danger small">{{ form.add_mother_nid.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_mother_birthdate" class="form-label">Mother's Date of Birth</label>
          {{ form.add_mother_birthdate }}
          {% if form.add_mother_birthdate.errors %}<div class="text-danger small">{{ form.add_mother_birthdate.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_parent_select" class="form-label">Select Guardian</label>
          {{ form.add_parent_select }}
          {% if form.add_parent_select.errors %}<div class="text-danger small">{{ form.add_parent_select.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_parent" class="form-label">Guardian's Name</label>
          {{ form.add_parent }}
          {% if form.add_parent.errors %}<div class="text-danger small">{{ form.add_parent.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_parent_mobile" class="form-label">Guardian's Mobile</label>
          {{ form.add_parent_mobile }}
          {% if form.add_parent_mobile.errors %}<div class="text-danger small">{{ form.add_parent_mobile.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_parent_relation" class="form-label">Guardian Relation</label>
          {{ form.add_parent_relation }}
          {% if form.add_parent_relation.errors %}<div class="text-danger small">{{ form.add_parent_relation.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_parent_service" class="form-label">Guardian Profession</label>
          {{ form.add_parent_service }}
          {% if form.add_parent_service.errors %}<div class="text-danger small">{{ form.add_parent_service.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_parent_nid" class="form-label">Guardian NID</label>
          {{ form.add_parent_nid }}
          {% if form.add_parent_nid.errors %}<div class="text-danger small">{{ form.add_parent_nid.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_parent_income" class="form-label">Guardian Income</label>
          {{ form.add_parent_income }}
          {% if form.add_parent_income.errors %}<div class="text-danger small">{{ form.add_parent_income.errors.0 }}</div>{% endif %}
        </div>
      </div>
    </div>

    <!-- Address -->
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">Address</h5></div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label for="id_add_village" class="form-label">Village</label>
          {{ form.add_village }}
          {% if form.add_village.errors %}<div class="text-danger small">{{ form.add_village.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_post" class="form-label">Post Office</label>
          {{ form.add_post }}
          {% if form.add_post.errors %}<div class="text-danger small">{{ form.add_post.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_police" class="form-label">Police Station/Upazila</label>
          {{ form.add_police }}
          {% if form.add_police.errors %}<div class="text-danger small">{{ form.add_police.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_postal" class="form-label">Postal Code</label>
          {{ form.add_postal }}
          {% if form.add_postal.errors %}<div class="text-danger small">{{ form.add_postal.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_distric" class="form-label">District</label>
          {{ form.add_distric }}
          {% if form.add_distric.errors %}<div class="text-danger small">{{ form.add_distric.errors.0 }}</div>{% endif %}
        </div>

        <div class="col-md-12 mt-2">
          <label class="switch switch-success my-2">
            <input type="checkbox" name="add_address_same" id="id_add_address_same" class="switch-input"
                   {% if form.add_address_same.value %}checked{% endif %}>
            <span class="switch-toggle-slider">
              <span class="switch-on"><i class="ti ti-check"></i></span>
              <span class="switch-off"><i class="ti ti-x"></i></span>
            </span>
            <span class="switch-label">Same as Present Address</span>
          </label>
        </div>

        <div class="col-md-4">
          <label for="id_add_village_per" class="form-label">Village (Permanent)</label>
          {{ form.add_village_per }}
          {% if form.add_village_per.errors %}<div class="text-danger small">{{ form.add_village_per.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_post_per" class="form-label">Post Office (Permanent)</label>
          {{ form.add_post_per }}
          {% if form.add_post_per.errors %}<div class="text-danger small">{{ form.add_post_per.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_police_per" class="form-label">Police Station/Upazila (Permanent)</label>
          {{ form.add_police_per }}
          {% if form.add_police_per.errors %}<div class="text-danger small">{{ form.add_police_per.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_postal_per" class="form-label">Postal Code (Permanent)</label>
          {{ form.add_postal_per }}
          {% if form.add_postal_per.errors %}<div class="text-danger small">{{ form.add_postal_per.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_distric_per" class="form-label">District (Permanent)</label>
          {{ form.add_distric_per }}
          {% if form.add_distric_per.errors %}<div class="text-danger small">{{ form.add_distric_per.errors.0 }}</div>{% endif %}
        </div>
      </div>
    </div>

    <!-- Quota/Community -->
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">Quota/Community Information</h5></div>
      <div class="card-body row g-3">
        <div class="col-md-2">
          <label class="form-label">Quota Applicable</label>
          <div class="form-check">
            <input type="radio" name="qouta" id="id_qouta_yes" value="True" class="form-check-input" {% if form.qouta.value %}checked{% endif %}>
            <label for="id_qouta_yes" class="form-check-label">Yes</label>
          </div>
          <div class="form-check">
            <input type="radio" name="qouta" id="id_qouta_no" value="False" class="form-check-input" {% if not form.qouta.value %}checked{% endif %}>
            <label for="id_qouta_no" class="form-check-label">No</label>
          </div>
          {% if form.qouta.errors %}<div class="text-danger small">{{ form.qouta.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-10">
          <div id="qouta_name_container" style="display: {% if form.qouta.value %}block{% else %}none{% endif %};">
            <label for="id_qouta_name" class="form-label">Quota Name</label>
            {{ form.qouta_name }}
            {% if form.qouta_name.errors %}<div class="text-danger small">{{ form.qouta_name.errors.0 }}</div>{% endif %}
          </div>
        </div>

        <div class="col-md-2">
          <label class="form-label">Community Applicable</label>
          <div class="form-check">
            <input type="radio" name="community" id="id_community_yes" value="True" class="form-check-input" {% if form.community.value %}checked{% endif %}>
            <label for="id_community_yes" class="form-check-label">Yes</label>
          </div>
          <div class="form-check">
            <input type="radio" name="community" id="id_community_no" value="False" class="form-check-input" {% if not form.community.value %}checked{% endif %}>
            <label for="id_community_no" class="form-check-label">No</label>
          </div>
          {% if form.community.errors %}<div class="text-danger small">{{ form.community.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-10">
          <div id="community_name_container" style="display: {% if form.community.value %}block{% else %}none{% endif %};">
            <label for="id_community_name" class="form-label">Community Name</label>
            {{ form.community_name }}
            {% if form.community_name.errors %}<div class="text-danger small">{{ form.community_name.errors.0 }}</div>{% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Academic (SSC) -->
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0">Academic Information (SSC)</h5></div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label for="id_add_ssc_roll" class="form-label">Roll</label>
          {{ form.add_ssc_roll }}
          {% if form.add_ssc_roll.errors %}<div class="text-danger small">{{ form.add_ssc_roll.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_ssc_reg" class="form-label">Registration No</label>
          {{ form.add_ssc_reg }}
          {% if form.add_ssc_reg.errors %}<div class="text-danger small">{{ form.add_ssc_reg.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_ssc_board" class="form-label">Board</label>
          {{ form.add_ssc_board }}
          {% if form.add_ssc_board.errors %}<div class="text-danger small">{{ form.add_ssc_board.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_ssc_group" class="form-label">Group</label>
          {{ form.add_ssc_group }}
          {% if form.add_ssc_group.errors %}<div class="text-danger small">{{ form.add_ssc_group.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_ssc_passyear" class="form-label">Pass Year</label>
          {{ form.add_ssc_passyear }}
          {% if form.add_ssc_passyear.errors %}<div class="text-danger small">{{ form.add_ssc_passyear.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_ssc_gpa" class="form-label">GPA</label>
          {{ form.add_ssc_gpa }}
          {% if form.add_ssc_gpa.errors %}<div class="text-danger small">{{ form.add_ssc_gpa.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-4">
          <label for="id_add_ssc_session" class="form-label">SSC Session</label>
          {{ form.add_ssc_session }}
          {% if form.add_ssc_session.errors %}<div class="text-danger small">{{ form.add_ssc_session.errors.0 }}</div>{% endif %}
        </div>
        <div class="col-md-8">
          <label for="id_add_ssc_institute" class="form-label">SSC Institute</label>
          {{ form.add_ssc_institute }}
          {% if form.add_ssc_institute.errors %}<div class="text-danger small">{{ form.add_ssc_institute.errors.0 }}</div>{% endif %}
        </div>
      </div>
    </div>

    <!-- Subject Selection (Commerce) -->
    <div class="card mb-4">
      <div class="alert alert-warning d-flex align-items-start gap-3 shadow-sm rounded-3 border border-warning border-2 m-3"
           role="alert" style="border-left-width:.6rem;">
        <div class="fs-3 lh-1">⚠️</div>
        <div><p class="mb-0 text-dark fw-bold">Note: Please choose subject carefully!</p></div>
      </div>

      <div class="card-header"><h5 class="mb-0">Subject Selection</h5></div>
      <div class="card-body row g-3">
        <div class="col-md-4">
          <label class="form-label d-block mb-2">Common Subjects</label>
          {% for sub in subjects_all %}
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" disabled checked>
              <label class="form-check-label">{{ sub.sub_name }}</label>
            </div>
          {% endfor %}
        </div>

        <div class="col-md-4">
          <label class="form-label d-block mb-2">Optional Subjects</label>
          {% for sub in subjects_optional %}
            <div class="form-check mb-2">
              <input class="form-check-input" type="radio" disabled checked>
              <label class="form-check-label">{{ sub.sub_name }}</label>
            </div>
          {% endfor %}
        </div>

        <!-- Additional subject (auto-selected & disabled, but submitted via hidden input) -->
        <div class="col-md-4">
          <label class="form-label d-block mb-2">Additional Subject</label>
          {% if subjects_fourth %}
            {% with selected_id=student.fourth_subject.id|default:subjects_fourth.0.id %}
              <input type="hidden" name="fourth_subject" value="{{ selected_id }}">
              {% for sub in subjects_fourth %}
                <div class="form-check mb-2">
                  <input class="form-check-input" type="radio" disabled {% if sub.id == selected_id %}checked{% endif %}>
                  <label class="form-check-label">{{ sub.sub_name }}</label>
                </div>
              {% endfor %}
            {% endwith %}
          {% else %}
            <div class="text-muted small">No additional subject configured.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Payment -->
    <div class="card mb-4">
      <div class="alert alert-success d-flex align-items-start gap-3 shadow-sm rounded-3 border border-success border-2 m-3"
           role="alert" style="border-left-width:.6rem;">
        <div class="fs-3 lh-1">✅</div>
        <div>
          <p class="mb-0 text-dark fw-bold">
            For Instruction click
            <a target="_blank" href="{% static 'cus/ins.jpeg' %}">here</a>
          </p>
        </div>
      </div>

      <div class="card-header">
        <h5 class="mb-0">Payment Details
          {% if request.user.role == 'student' %}
          <span class="badge bg-primary rounded-pill">
            Payment Student ID : {{ request.user.id }}
          </span>
          {% else %}
          <span class="badge bg-primary rounded-pill">
            Payment Student ID :
            {{ student.created_by.id|default:student.id|default:0 }}
          </span>
          {% endif %}
        </h5>
      </div>

      <div class="card-body row g-3">
        <div class="col-md-6">
          <label for="id_add_amount" class="form-label">Admission Fee</label>
          {{ form.add_amount }}
          {% if form.add_amount.errors %}<div class="text-danger small">{{ form.add_amount.errors.0 }}</div>{% endif %}
        </div>

        <div class="col-md-6">
          <label for="{{ form.add_payment_method.id_for_label }}" class="form-label">Payment Method</label>
          {{ form.add_payment_method }}
          {% if form.add_payment_method.errors %}<div class="text-danger small">{{ form.add_payment_method.errors.0 }}</div>{% endif %}
        </div>

        <div class="col-md-6">
          <label for="{{ form.add_trxid.id_for_label }}" class="form-label">
            Transaction ID <span class="text-danger">*</span>
          </label>
          {{ form.add_trxid }}
          {% if form.add_trxid.errors %}
            <div class="text-danger small">{{ form.add_trxid.errors.0 }}</div>
          {% endif %}
        </div>

        <div class="col-md-6">
          <label for="{{ form.add_slip.id_for_label }}" class="form-label">
            Payment From <span class="text-danger">*</span>
          </label>
          {{ form.add_slip }}
          {% if form.add_slip.errors %}
            <div class="text-danger small">{{ form.add_slip.errors.0 }}</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="text-center">
      <button type="submit" class="btn btn-primary">Submit Admission</button>
    </div>
  </form>
</div>

<!-- ====== Scripts ====== -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  /* Guardian auto-fill */
  (function () {
    const guardianSelect = document.getElementById("id_add_parent_select");
    const fatherName     = document.getElementById("id_add_father");
    const fatherMobile   = document.getElementById("id_add_father_mobile");
    const fatherNid      = document.getElementById("id_add_father_nid");
    const motherName     = document.getElementById("id_add_mother");
    const motherMobile   = document.getElementById("id_add_mother_mobile");
    const motherNid      = document.getElementById("id_add_mother_nid");

    const gName   = document.getElementById("id_add_parent");
    const gMobile = document.getElementById("id_add_parent_mobile");
    const gNid    = document.getElementById("id_add_parent_nid");
    const gRel    = document.getElementById("id_add_parent_relation");

    function syncGuardian() {
      const sel = guardianSelect?.value || "";
      if (sel === "father") {
        if (gName)   gName.value   = fatherName?.value || "";
        if (gMobile) gMobile.value = fatherMobile?.value || "";
        if (gNid)    gNid.value    = fatherNid?.value || "";
        if (gRel)    gRel.value    = "Father";
      } else if (sel === "mother") {
        if (gName)   gName.value   = motherName?.value || "";
        if (gMobile) gMobile.value = motherMobile?.value || "";
        if (gNid)    gNid.value    = motherNid?.value || "";
        if (gRel)    gRel.value    = "Mother";
      } else {
        if (gName)   gName.value   = "";
        if (gMobile) gMobile.value = "";
        if (gNid)    gNid.value    = "";
        if (gRel)    gRel.value    = "";
      }
    }

    guardianSelect?.addEventListener("change", syncGuardian);
    fatherName?.addEventListener("input", syncGuardian);
    fatherMobile?.addEventListener("input", syncGuardian);
    fatherNid?.addEventListener("input", syncGuardian);
    motherName?.addEventListener("input", syncGuardian);
    motherMobile?.addEventListener("input", syncGuardian);
    motherNid?.addEventListener("input", syncGuardian);
    syncGuardian();
  })();

  /* Address live copy */

/* Address live copy — safe for edit mode */
(function () {
  const cb = document.getElementById("id_add_address_same")
            || document.querySelector('input[name="add_address_same"]');
  const PAIRS = [
    ["id_add_village", "id_add_village_per"],
    ["id_add_post", "id_add_post_per"],
    ["id_add_police", "id_add_police_per"],
    ["id_add_postal", "id_add_postal_per"],
    ["id_add_distric", "id_add_distric_per"],
  ];

  function setRO(ro){
    PAIRS.forEach(([, d]) => {
      const dst = document.getElementById(d);
      if (dst) dst.readOnly = ro;
    });
  }

  function copyAll(){
    PAIRS.forEach(([s, d]) => {
      const src = document.getElementById(s);
      const dst = document.getElementById(d);
      if (src && dst) {
        dst.value = src.value || "";
        dst.dataset.autofilled = "1"; // mark
      }
    });
  }

  // live mirroring handlers
  let unsubs = [];
  function bindMirroring(){
    unbindMirroring();
    PAIRS.forEach(([s, d]) => {
      const src = document.getElementById(s);
      const dst = document.getElementById(d);
      if (!src || !dst) return;
      const h = () => {
        dst.value = src.value || "";
        dst.dataset.autofilled = "1";
      };
      src.addEventListener("input", h);
      src.addEventListener("change", h);
      unsubs.push(() => {
        src.removeEventListener("input", h);
        src.removeEventListener("change", h);
      });
    });
  }
  function unbindMirroring(){
    unsubs.forEach(fn => fn());
    unsubs = [];
  }

  function clearAutoFilled(){
    PAIRS.forEach(([, d]) => {
      const dst = document.getElementById(d);
      if (dst && dst.dataset.autofilled === "1") {
        dst.value = "";                // clear only ones we auto-filled
        delete dst.dataset.autofilled; // unmark
      }
    });
  }

  if (!cb) return;

  let initialized = false;
  // remember previous state to know if user toggled off
  cb.dataset.prev = cb.checked ? "1" : "0";

  function apply(){
    const isChecked = cb.checked;
    const wasChecked = cb.dataset.prev === "1";

    if (isChecked) {
      copyAll();
      bindMirroring();
      setRO(true);
    } else {
      unbindMirroring();
      setRO(false);
      // Only clear if user turned it OFF now; don't clear on initial load
      if (initialized && wasChecked && !isChecked) {
        clearAutoFilled();
      }
    }

    cb.dataset.prev = isChecked ? "1" : "0";
    if (!initialized) initialized = true;
  }

  // Initial load: do nothing destructive; only apply if already checked
  if (cb.checked) apply();
  cb.addEventListener("change", apply);
})();

  /* Fee loader + hidden mirror (commerce group forced) */
  (function () {
    const sessionSelect = document.getElementById("id_add_session");
    const feeField      = document.getElementById("id_add_amount");
    if (!sessionSelect || !feeField) return;

    function ensureHiddenMirror() {
      if (!sessionSelect.disabled) return;
      let hidden = document.querySelector('input[name="add_session_hidden"]');
      if (!hidden) {
        hidden = document.createElement("input");
        hidden.type = "hidden";
        hidden.name = "add_session_hidden";
        sessionSelect.parentNode.appendChild(hidden);
      }
      hidden.value = sessionSelect.value || "";
    }

    function loadFee() {
      const sessionId = sessionSelect.value;
      if (!sessionId) return;
      const group = "commerce";

      fetch(`/dashboard/api/fee/admission/?session=${sessionId}&program=HSC&group=${group}`)
        .then(res => res.json())
        .then(data => { feeField.value = (data && data.amount) ? data.amount : 0; })
        .catch(err => console.error("Fee fetch error:", err));

      ensureHiddenMirror();
    }

    loadFee();
    if (!sessionSelect.disabled) {
      sessionSelect.addEventListener("change", loadFee);
    } else {
      setTimeout(loadFee, 0);
      const mo = new MutationObserver(loadFee);
      mo.observe(sessionSelect, { attributes: true, attributeFilter: ["value","disabled"] });
    }
  })();

  /* Quota & Community toggle */
  (function () {
    function setupToggle(yesId,noId,containerId,inputId){
      const yes=document.getElementById(yesId);
      const no =document.getElementById(noId);
      const cont=document.getElementById(containerId);
      const inp=document.getElementById(inputId);
      function apply(){
        if(!cont) return;
        const show = yes?.checked===true;
        cont.style.display = show ? "block":"none";
        if (inp){ inp.toggleAttribute("required", show); if(!show) inp.value=""; }
      }
      yes?.addEventListener("change",apply);
      no ?.addEventListener("change",apply);
      apply();
    }
    setupToggle("id_qouta_yes","id_qouta_no","qouta_name_container","id_qouta_name");
    setupToggle("id_community_yes","id_community_no","community_name_container","id_community_name");
  })();

  /* Photo size client-side hint */
  (function () {
    const input = document.getElementById("id_add_photo");
    const hint  = document.getElementById("photo-size-hint");
    if (!input) return;
    input.addEventListener("change", function () {
      if (!this.files || !this.files[0]) return;
      if (this.files[0].size > 500 * 1024) {
        if (hint) hint.style.display = "block";
      } else {
        if (hint) hint.style.display = "none";
      }
    });
  })();

});
</script>
{% endblock %}
