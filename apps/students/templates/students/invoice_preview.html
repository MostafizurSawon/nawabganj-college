<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Invoice â€” {{ student.add_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet"/>

  <style>
    :root{
      --page-w: 210mm;   /* A4 width */
      --pad: 6mm;        /* inner padding around the whole page */
    }
    body{ background:#f6f7fb; }

    /* Printable page (we draw exactly one page and export it 1:1) */
    .pdf-page{
      width: calc(var(--page-w) - 2mm); /* a bit wider than before to reduce white edges */
      margin: 0 auto;
      padding: var(--pad);
      background:#fff;
      box-shadow: 0 8px 28px rgba(32,40,45,.08);
      box-sizing: border-box;
    }

    .inv-copy{
      border:1px solid #e6e9ef;
      border-radius:.5rem;
      padding:14px;
    }

    .header-wrap{ position:relative; padding-top:6px; }
    .copy-badge{
      position:absolute; right:0; top:-6px;
      font-weight:700; letter-spacing:.3px;
    }
    .inv-rule{ height:3px; background:#2f3c4d; opacity:.85; margin:10px 0 14px; }
    .title{ font-weight:800; letter-spacing:1px; }

    /* SOLID status chips */
    .status-badge{ display:inline-block; font-weight:800; letter-spacing:.5px; padding:.25rem .6rem; border-radius:.35rem; color:#fff; }
    .status-paid{ background:#198754; }
    .status-pending{ background:#f6c744; color:#1f2328; }
    .status-unpaid{ background:#dc3545; }

    /* Key/Value table: exact column widths + nowrap */
    .kv{ table-layout: fixed; width:100%; }
    .kv col.c-lbl{ width:26%; }
    .kv col.c-val{ width:24%; }
    .kv th, .kv td{
      padding:.52rem .65rem !important;
      border:1px solid #e6e9ef !important;
      vertical-align:middle;
      font-size:.95rem;
      white-space:nowrap;           /* ðŸ”’ stay in one line */
      overflow:hidden; text-overflow:ellipsis;
    }
    .kv th{ background:#f1f3f5; font-weight:700; }

    /* Items table */
    .items{ table-layout: fixed; width:100%; }
    .items th, .items td{
      padding:.6rem .75rem !important;
      border:1px solid #e6e9ef !important;
      vertical-align:middle;
    }
    .items thead th{ background:#f8f9fa; font-weight:700; }
    .items tfoot th{ background:#f8f9fa; font-size:1.02rem; }

    /* Cut line between copies */
    .cut{ margin:10px 0; position:relative; text-align:center; color:#9099a8; }
    .cut:before{
      content:""; position:absolute; left:0; right:0; top:50%;
      border-top:1px dashed #cbd3da; transform:translateY(-50%);
      z-index:1;
    }
    .cut span{ position:relative; z-index:2; background:#fff; padding:0 .6rem; font-size:.85rem; }

    .footer-note{ font-size:.85rem; color:#6c757d; }

    /* Controls hidden in print; keep colors intact */
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      .pdf-page{ box-shadow:none; }
    }
  </style>
</head>
<body>

<!-- Top controls -->
<div class="container my-3 no-print">
  <div class="d-flex justify-content-between align-items-center">
    <a href="{{ back_url|default:request.META.HTTP_REFERER|default:'/' }}" class="btn btn-sm btn-outline-secondary">
      <i class="ti ti-arrow-left me-1"></i> Back
    </a>
    <button class="btn btn-sm btn-primary" id="btnPdf">
      <i class="ti ti-file-type-pdf me-1"></i> Download PDF
    </button>
  </div>
</div>

<!-- ===== One printable page ===== -->
<div id="pdfPage" class="pdf-page">

  <!-- ===== COLLEGE COPY ===== -->
  <section class="inv-copy mb-3">

    <div class="header-wrap">
      <span class="badge bg-primary copy-badge">COLLEGE COPY</span>
      <div class="text-center fw-semibold">{{ org_name_bn|default:"" }}, {{ org_address_bn|default:"" }}</div>
      <div class="inv-rule"></div>
      <h5 class="title text-center mb-2">MANUAL INVOICE</h5> 
      <div class="text-center mb-2">
        <span class="status-badge
          {% if student.add_payment_status == 'paid' %}status-paid
          {% elif student.add_payment_status == 'pending' %}status-pending
          {% else %}status-unpaid{% endif %}">
          {% if student.add_payment_status == 'paid' %}PAID
          {% elif student.add_payment_status == 'pending' %}PENDING
          {% else %}UNPAID{% endif %}
        </span>
        {% comment %} <span># {{ invoice_no }}</span> {% endcomment %}
      </div>
    </div>

    <table class="table table-bordered table-sm kv mb-2">
      <colgroup>
        <col class="c-lbl"><col class="c-val"><col class="c-lbl"><col class="c-val">
      </colgroup>
      <tbody>
        <tr>
          <th>Name:</th><td>{{ student.add_name }} </td>
          <th>Payment Student ID:</th><td> 
            {% if request.user.role == 'student' %}
              {{ request.user.id }}
            {% else %}
              {{ student.created_by.id }}
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>Student Roll:</th><td>{{ student.add_class_roll|default:"" }}</td>
          <th>Payment Date:</th><td>{{ payment_date|date:"d F, Y" }}</td>
        </tr>
        <tr>
          <th>Payment Method:</th><td>{{ student.get_add_payment_method_display|default:"â€”" }}</td>
          <th>Transaction ID:</th><td>{{ student.add_trxid|default:"â€”" }}</td>
          
        </tr>
        <tr>
          <th>Mobile:</th><td>{{ student.add_mobile }}</td>
          <th>Payment From:</th><td>{{ student.add_slip|default:"â€”" }}</td>
        </tr>
      </tbody>
    </table>

    <table class="table table-bordered table-sm items mb-2">
      <thead>
        <tr>
          <th>Description</th>
          <th class="text-end" style="width: 180px;">Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            Hsc Admission Fee ({{ student.get_add_admission_group_display }}) | Invoice Number: {{ invoice_no }}
            {% comment %} {{ student.add_payment_note|default:"" }} {% endcomment %}
            {% comment %} {{ line_description|default:"HSC Admission Fee" }} {% endcomment %}
        </td>
          <td class="text-end">{{ student.add_amount|default:0 }} BDT</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <th class="text-end">Total Amount</th>
          <th class="text-end">{{ student.add_amount|default:0 }} BDT</th>
        </tr>
      </tfoot>
    </table>

    <div class="footer-note text-center">
      Receipt printed on {% now "d F, Y h:i A" %}.<br/>
      Powered by {{ org_name_en|default:"" }}. Design & Develop by JBD IT.
    </div>
  </section>

  <!-- Cut line -->
  <div class="cut"><span>âœ‚ Cut Here</span></div>

  <!-- ===== STUDENT COPY ===== -->
  <section class="inv-copy">
    <div class="header-wrap">
      <span class="badge bg-danger copy-badge">STUDENT COPY</span>
      <div class="text-center fw-semibold">{{ org_name_bn|default:"" }}, {{ org_address_bn|default:"" }}</div>
      <div class="inv-rule"></div>
      <h5 class="title text-center mb-2">MANUAL INVOICE</h5>
      <div class="text-center mb-2">
        <span class="status-badge
          {% if student.add_payment_status == 'paid' %}status-paid
          {% elif student.add_payment_status == 'pending' %}status-pending
          {% else %}status-unpaid{% endif %}">
          {% if student.add_payment_status == 'paid' %}PAID
          {% elif student.add_payment_status == 'pending' %}PENDING
          {% else %}UNPAID{% endif %}
        </span>
      </div>
    </div>

    <table class="table table-bordered table-sm kv mb-2">
      <colgroup>
        <col class="c-lbl"><col class="c-val"><col class="c-lbl"><col class="c-val">
      </colgroup>
      <tbody>
        <tr>
          <th>Name:</th><td>{{ student.add_name }} </td>
          <th>Payment Student ID:</th><td> 
            {% if request.user.role == 'student' %}
              {{ request.user.id }}
            {% else %}
              {{ student.created_by.id }}
            {% endif %}
          </td>
        </tr>
        <tr>
          <th>Student Roll:</th><td>{{ student.add_class_roll|default:"" }}</td>
          <th>Payment Date:</th><td>{{ payment_date|date:"d F, Y" }}</td>
        </tr>
        <tr>
          <th>Payment Method:</th><td>{{ student.get_add_payment_method_display|default:"â€”" }}</td>
          <th>Transaction ID:</th><td>{{ student.add_trxid|default:"â€”" }}</td>
          
        </tr>
        <tr>
          <th>Mobile:</th><td>{{ student.add_mobile }}</td>
          <th>Payment From:</th><td>{{ student.add_slip|default:"â€”" }}</td>
        </tr>
      </tbody>
    </table>

    <table class="table table-bordered table-sm items mb-2">
      <thead>
        <tr>
          <th>Description</th>
          <th class="text-end" style="width: 180px;">Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            Hsc Admission Fee ({{ student.get_add_admission_group_display }}) | Invoice Number: {{ invoice_no }}
            {% comment %} {{ student.add_payment_note|default:"" }} {% endcomment %}
            {% comment %} {{ line_description|default:"HSC Admission Fee" }} {% endcomment %}
          </td>
          
          <td class="text-end">{{ student.add_amount|default:0 }} BDT</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <th class="text-end">Total Amount</th>
          <th class="text-end">{{ student.add_amount|default:0 }} BDT</th>
        </tr>
      </tfoot>
    </table>

    <div class="footer-note text-center">
      Receipt printed on {% now "d F, Y h:i A" %}.<br/>
      Powered by {{ org_name_en|default:"" }}. Design & Develop by JBD IT.
    </div>
  </section>

</div>

<!-- PDF export -->
{% comment %} <div class="container my-3 no-print text-end">
  <button class="btn btn-sm btn-primary" id="btnPdfBottom">
    <i class="ti ti-file-type-pdf me-1"></i> Download PDF
  </button>
</div> {% endcomment %}

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
  async function downloadPDF(){
    const { jsPDF } = window.jspdf;
    const node = document.getElementById('pdfPage');

    // High-res canvas
    const canvas = await html2canvas(node, {
      scale: 2, backgroundColor: '#ffffff', useCORS: true, logging: false
    });
    const img = canvas.toDataURL('image/jpeg', 0.95);

    const pdf = new jsPDF('p', 'mm', 'a4');

    // Tighter margins (â‰ˆ4mm)
    const pageW = pdf.internal.pageSize.getWidth();
    const pageH = pdf.internal.pageSize.getHeight();
    const margin = 4;

    let w = pageW - margin*2;
    let h = canvas.height * w / canvas.width;
    if (h > pageH - margin*2){
      h = pageH - margin*2;
      w = canvas.width * h / canvas.height;
    }
    const x = (pageW - w) / 2;
    const y = (pageH - h) / 2;

    pdf.addImage(img, 'JPEG', x, y, w, h);
    const fname = ("{{ invoice_no|default:'invoice' }}").replace(/\s+/g,'-');
    pdf.save(fname + '.pdf');
  }
  document.getElementById('btnPdf').addEventListener('click', downloadPDF);
  document.getElementById('btnPdfBottom').addEventListener('click', downloadPDF);
</script>

</body>
</html>
