{% extends layout_path %}
{% load static %}
{% block title %}Expense Lists{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/quill/editor.css' %}">
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
{% endblock %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/quill/quill.js' %}"></script>
<script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
{% endblock %}

{% block page_js %}
<script>
  let quill;

  $(document).ready(function () {
    // Initialize DataTable
    $('#expense-table').DataTable({
      processing: true,
      serverSide: true,
      ajax: {
        url: '{% url "expense_data" %}',
        data: function (d) {
          d.category = $('[name="category"]').val();
          d.start_date = $('[name="start_date"]').val();
          d.end_date = $('[name="end_date"]').val();
        },
        dataSrc: function (json) {
          $('#total-amount').text(`৳ ${parseFloat(json.total_amount).toFixed(2)}`);
          return json.data;
        }
      },

      columns: [
        { data: 'sl', title: '#' },
        {
          data: null,
          title: 'Actions',
          orderable: false,
          searchable: false,
          render: function (data, type, row) {
            return `
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-icon btn-primary edit-expense" data-id="${row.id}" title="Edit">
                  <i class="ti ti-edit"></i>
                </button>
                <button class="btn btn-sm btn-icon btn-danger delete-expense" data-id="${row.id}" title="Delete">
                  <i class="ti ti-trash"></i>
                </button>
              </div>
            `;
          }
        },
        { data: 'date', title: 'Date' },
        { data: 'category', title: 'Category' },
        { data: 'name', title: 'Name' },
        { data: 'amount', title: 'Amount' },
        { data: 'note', title: 'Note' }
      ],
      order: [[2, 'desc']]
    });

    $('form').on('submit', function (e) {
      e.preventDefault();
      $('#expense-table').DataTable().ajax.reload();
    });

    // Initialize Quill
    quill = new Quill('#note-editor', {
      theme: 'snow',
      modules: {
        toolbar: '#note-toolbar'
      }
    });

    // Form Submit Handler
    $('#addExpenseModal form').on('submit', function (e) {
      e.preventDefault();

      if (typeof quill !== 'undefined') {
        $('#note-input').val(quill.root.innerHTML);
      }

      const form = $(this);
      const url = form.attr('action');
      const data = form.serialize();

      $.ajax({
        type: 'POST',
        url: url,
        data: data,
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        success: function (response) {
          $('#expense-table').DataTable().ajax.reload();
          $('#addExpenseModal').modal('hide');
          resetExpenseModal();
          toastr.success(response.message);
        },
        error: function (xhr) {
          const msg = xhr.responseJSON?.message || 'Failed to submit expense.';
          toastr.error(msg);
        }
      });
    });

    // Reset modal on close
    $('#addExpenseModal').on('hidden.bs.modal', function () {
      resetExpenseModal();
    });
  });

  // Delete Expense
  $(document).on('click', '.delete-expense', function () {
    const id = $(this).data('id');
    if (confirm('Are you sure you want to delete this expense?')) {
      $.ajax({
        url: `/finances/expenses/delete/${id}/`,
        type: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        success: function (res) {
          $('#expense-table').DataTable().ajax.reload();
          toastr.success(res.message);
        },
        error: function () {
          toastr.error('Delete failed!');
        }
      });
    }
  });

  // Edit Expense
  $(document).on('click', '.edit-expense', function () {
    const id = $(this).data('id');

    $.get(`/finances/expenses/data/${id}/`, function (data) {
      if (data.success) {
        const expense = data.expense;
        $('[name="exp_name"]').val(expense.name);
        $('[name="amount"]').val(expense.amount);
        $('[name="date"]').val(expense.date);
        $('[name="exp_category"]').val(expense.category_id);
        if (typeof quill !== 'undefined') {
          quill.root.innerHTML = expense.note || '';
        }
        $('#addExpenseModal .modal-title').text('Edit Expense');
        $('#addExpenseModal button[type="submit"]').text('Update Expense');
        $('#addExpenseModal form').attr('action', `/finances/expenses/edit/${id}/`);
        $('#addExpenseModal').modal('show');
      } else {
        toastr.error('Failed to load expense details.');
      }
    });
  });

  function resetExpenseModal() {
    $('#addExpenseModal form').trigger('reset');
    $('#addExpenseModal form').attr('action', '{% url "expense_list" %}');
    $('#addExpenseModal .modal-title').text('Add Expense');
    $('#addExpenseModal button[type="submit"]').text('Save Expense');
    if (typeof quill !== 'undefined') {
      quill.root.innerHTML = '';
    }
  }
</script>
{% endblock %}


{% block content %}

<style>
  #expense-table th,
  #expense-table td {
    border-left: 1px solid #dee2e6 !important;
    border-right: 1px solid #dee2e6 !important;
  }

  #expense-table {
    border-collapse: separate;
    border-spacing: 0;
  }
  /* Ensure toast background and text are readable */
  #toast-container > .toast {
    background-color: #323232 !important;
    color: #fff !important;
    font-weight: 500;
    box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.2);
  }

  #toast-container > .toast-success {
    background-color: #28c76f !important;
  }

  #toast-container > .toast-error {
    background-color: #ea5455 !important;
  }

  #toast-container > .toast-info {
    background-color: #00cfe8 !important;
  }

  #toast-container > .toast-warning {
    background-color: #ff9f43 !important;
  }

  #toast-container > .toast i {
    color: #fff !important;
  }


  .modal-content {
    height: 650px;
  }
</style>


<!-- Messages -->
{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
{% endif %}

<!-- Page Header -->
<div class="content-header">
  <h4 class="mb-2">Expense List</h4>
</div>

<!-- Filters -->
<div class="card p-2 mb-2">
  <form method="get" class="row g-2">
    <div class="col-md-3">
      <input type="text" name="search" value="{{ search_query }}" class="form-control" placeholder="Search expense name or note">
    </div>
    <div class="col-md-3">
      <select name="category" class="form-select">
        <option value="">All Categories</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}" {% if category_filter == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
    </div>
    <div class="col-md-2">
      <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
    </div>

    <div class="col-md-1">
      <button class="btn btn-primary w-100" type="submit">Filter</button>
    </div>

    <div class="col-md-1">
      <a href="{% url 'expense_list' %}" class="btn btn-secondary w-100">Reset</a>
    </div>


  </form>
</div>


<!-- Expense Table -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title">Expenses</h5>
    <div class="text-end">
      <button type="button" class="btn btn-success w-100" onclick="resetExpenseModal()" data-bs-toggle="modal" data-bs-target="#addExpenseModal">
        + Add Expense
      </button>
    </div>
  </div>

  <div class="text-end mt-3 pe-5">
      <h6><strong>Total Amount:</strong> <span id="total-amount" class="">৳ 0.00</span></h6>
    </div>

  <div class="card-datatable text-nowrap table-responsive p-2">
    <table class="table table-bordered" id="expense-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Actions</th>
          <th>Date</th>
          <th>Category</th>
          <th>Name</th>
          <th>Amount</th>
          <th>Note</th>
        </tr>
      </thead>

    </table>


  </div>
</div>

<!-- Add Expense Modal -->
<div class="modal fade" id="addExpenseModal" tabindex="-1" aria-labelledby="addExpenseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{% url 'expense_list' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add Expense</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body row g-4 px-4">

          <!-- Expense Name -->
          <div class="col-md-6">
            <label class="form-label" for="exp_name">Expense Name</label>
            <div class="input-group input-group-merge">
              <span class="input-group-text"><i class="ti ti-file-text"></i></span>
              <input type="text" name="exp_name" class="form-control" placeholder="Internet Bill" required>
            </div>
          </div>

          <!-- Amount -->
          <div class="col-md-6">
            <label class="form-label" for="amount">Amount</label>
            <div class="input-group input-group-merge">
              <span class="input-group-text"><i class="ti ti-currency-taka"></i></span>
              <input type="number" step="0.01" name="amount" class="form-control" placeholder="500.00" required>
            </div>
          </div>

          <!-- Date -->
          <div class="col-md-6">
            <label class="form-label" for="date">Date</label>
            <div class="input-group input-group-merge">
              <span class="input-group-text"><i class="ti ti-calendar"></i></span>
              <input type="date" name="date" class="form-control" required>
            </div>
          </div>

          <!-- Category -->
          <div class="col-md-6">
            <label class="form-label" for="exp_category">Category</label>
            <div class="input-group input-group-merge">
              <span class="input-group-text"><i class="ti ti-list"></i></span>
              <select name="exp_category" class="form-select" required>
                <option value="">Select Category</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Note -->
          <div class="col-12">
            <label class="form-label" for="note-editor">Note</label>
            <div id="note-toolbar" class="">
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
              </span>
              <span class="ql-formats">
                <select class="ql-color"></select>
                <select class="ql-background"></select>
              </span>
              <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
              </span>
            </div>
            <div id="note-editor" style="height: 250px;"></div>
            <input type="hidden" name="note" id="note-input">
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Expense</button>
          <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
