{% extends layout_path %}
{% load static %}
{% block title %}Income Lists{% endblock %}

{% block vendor_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendor/libs/quill/editor.css' %}">
<link rel="stylesheet" href="{% static 'vendor/libs/datatables-bs5/datatables.bootstrap5.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
{% endblock %}

{% block vendor_js %}
{{ block.super }}
<script src="{% static 'vendor/libs/quill/quill.js' %}"></script>
<script src="{% static 'vendor/libs/datatables-bs5/datatables-bootstrap5.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
{% endblock %}

{% block page_js %}
<script>
  let quill;

  $(document).ready(function () {
    // Initialize DataTable
    $('#income-table').DataTable({
      processing: true,
      serverSide: true,
      ajax: {
        url: '{% url "income_data" %}',
        data: function (d) {
          d.category = $('[name="category"]').val();
          d.start_date = $('[name="start_date"]').val();
          d.end_date = $('[name="end_date"]').val();
        },
        dataSrc: function (json) {
          $('#total-income-amount').text(`৳ ${parseFloat(json.total_amount).toFixed(2)}`);
          return json.data;
        }
      },
      columns: [
        { data: 'sl', title: '#' },
        {
          data: null,
          title: 'Actions',
          orderable: false,
          searchable: false,
          render: function (data) {
            return `
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-icon btn-primary edit-income" data-id="${data.id}">
                  <i class="ti ti-edit"></i>
                </button>
                <button class="btn btn-sm btn-icon btn-danger delete-income" data-id="${data.id}">
                  <i class="ti ti-trash"></i>
                </button>
              </div>
            `;
          }
        },
        { data: 'date', title: 'Date' },
        { data: 'category', title: 'Category' },
        { data: 'name', title: 'Name' },
        { data: 'amount', title: 'Amount' },
        { data: 'note', title: 'Note' }
      ],
      order: [[2, 'desc']]
    });

    $('form').on('submit', function (e) {
      e.preventDefault();
      $('#income-table').DataTable().ajax.reload();
    });

    // Quill editor
    quill = new Quill('#note-editor', {
      theme: 'snow',
      modules: {
        toolbar: '#note-toolbar'
      }
    });

    // Submit income form
    $('#addIncomeModal form').on('submit', function (e) {
      e.preventDefault();
      $('#note-input').val(quill.root.innerHTML);

      const form = $(this);
      const url = form.attr('action');
      const data = form.serialize();

      $.ajax({
        type: 'POST',
        url: url,
        data: data,
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        success: function (response) {
          $('#income-table').DataTable().ajax.reload();
          $('#addIncomeModal').modal('hide');
          resetIncomeModal();
          toastr.success(response.message);
        },
        error: function (xhr) {
          const msg = xhr.responseJSON?.message || 'Failed to submit income.';
          toastr.error(msg);
        }
      });
    });

    $('#addIncomeModal').on('hidden.bs.modal', resetIncomeModal);
  });

  $(document).on('click', '.delete-income', function () {
    const id = $(this).data('id');
    if (confirm('Are you sure you want to delete this income?')) {
      $.ajax({
        url: `/finances/incomes/delete/${id}/`,
        type: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' },
        success: function (res) {
          $('#income-table').DataTable().ajax.reload();
          toastr.success(res.message);
        },
        error: function () {
          toastr.error('Delete failed!');
        }
      });
    }
  });

  $(document).on('click', '.edit-income', function () {
    const id = $(this).data('id');
    $.get(`/finances/incomes/data/${id}/`, function (data) {
      if (data.success) {
        const income = data.income;
        $('[name="income_name"]').val(income.name);
        $('[name="amount"]').val(income.amount);
        $('[name="date"]').val(income.date);
        $('[name="income_category"]').val(income.category_id);
        quill.root.innerHTML = income.note || '';
        $('#addIncomeModal .modal-title').text('Edit Income');
        $('#addIncomeModal button[type="submit"]').text('Update Income');
        $('#addIncomeModal form').attr('action', `/finances/incomes/edit/${id}/`);
        $('#addIncomeModal').modal('show');
      } else {
        toastr.error('Failed to load income details.');
      }
    });
  });

  function resetIncomeModal() {
    $('#addIncomeModal form').trigger('reset');
    $('#addIncomeModal form').attr('action', '{% url "income_list" %}');
    $('#addIncomeModal .modal-title').text('Add Income');
    $('#addIncomeModal button[type="submit"]').text('Save Income');
    if (typeof quill !== 'undefined') {
      quill.root.innerHTML = '';
    }
  }
</script>
{% endblock %}

{% block content %}
<style>
  #expense-table th,
  #expense-table td {
    border-left: 1px solid #dee2e6 !important;
    border-right: 1px solid #dee2e6 !important;
  }

  #expense-table {
    border-collapse: separate;
    border-spacing: 0;
  }
  /* Ensure toast background and text are readable */
  #toast-container > .toast {
    background-color: #323232 !important;
    color: #fff !important;
    font-weight: 500;
    box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.2);
  }

  #toast-container > .toast-success {
    background-color: #28c76f !important;
  }

  #toast-container > .toast-error {
    background-color: #ea5455 !important;
  }

  #toast-container > .toast-info {
    background-color: #00cfe8 !important;
  }

  #toast-container > .toast-warning {
    background-color: #ff9f43 !important;
  }

  #toast-container > .toast i {
    color: #fff !important;
  }
</style>
<div class="content-header">
  <h4 class="mb-2">Income List</h4>
</div>

<div class="card p-2 mb-2">
  <form method="get" class="row g-2">
    <div class="col-md-3">
      <input type="text" name="search" value="{{ search_query }}" class="form-control" placeholder="Search income name or note">
    </div>
    <div class="col-md-3">
      <select name="category" class="form-select">
        <option value="">All Categories</option>
        {% for cat in categories %}
          <option value="{{ cat.id }}" {% if category_filter == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <input type="date" name="start_date" value="{{ start_date }}" class="form-control">
    </div>
    <div class="col-md-2">
      <input type="date" name="end_date" value="{{ end_date }}" class="form-control">
    </div>
    <div class="col-md-1">
      <button class="btn btn-primary w-100" type="submit">Filter</button>
    </div>
    <div class="col-md-1">
      <a href="{% url 'income_list' %}" class="btn btn-secondary w-100">Reset</a>
    </div>
  </form>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title">Incomes</h5>
    <button class="btn btn-success" onclick="resetIncomeModal()" data-bs-toggle="modal" data-bs-target="#addIncomeModal">+ Add Income</button>
  </div>
  <div class="text-end mt-3 pe-5">
    <h6><strong>Total Amount:</strong> <span id="total-income-amount">৳ 0.00</span></h6>
  </div>
  <div class="card-datatable text-nowrap table-responsive p-2">
    <table class="table table-bordered" id="income-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Actions</th>
          <th>Date</th>
          <th>Category</th>
          <th>Name</th>
          <th>Amount</th>
          <th>Note</th>
        </tr>
      </thead>
    </table>
  </div>
</div>

<!-- Add Income Modal -->
<!-- Add Income Modal -->
<div class="modal fade" id="addIncomeModal" tabindex="-1" aria-labelledby="addIncomeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{% url 'income_list' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Add Income</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body row g-4 px-4">

          <!-- Income Name -->
          <div class="col-md-6">
            <label class="form-label">Income Name</label>
            <div class="input-group input-group-merge">
              <span class="input-group-text"><i class="ti ti-file-text"></i></span>
              <input type="text" name="income_name" class="form-control" placeholder="Salary, Gift, etc." required>
            </div>
          </div>

          <!-- Amount -->
          <div class="col-md-6">
            <label class="form-label">Amount</label>
            <div class="input-group input-group-merge">
              <span class="input-group-text"><i class="ti ti-currency-taka"></i></span>
              <input type="number" step="0.01" name="amount" class="form-control" placeholder="1000.00" required>
            </div>
          </div>

          <!-- Date -->
          <div class="col-md-6">
            <label class="form-label">Date</label>
            <div class="input-group input-group-merge">
              <span class="input-group-text"><i class="ti ti-calendar"></i></span>
              <input type="date" name="date" class="form-control" required>
            </div>
          </div>

          <!-- Category -->
          <div class="col-md-6">
            <label class="form-label">Category</label>
            <div class="input-group input-group-merge">
              <span class="input-group-text"><i class="ti ti-list-details"></i></span>
              <select name="income_category" class="form-select" required>
                <option value="">Select Category</option>
                {% for cat in categories %}
                  <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Note -->
          <div class="col-12">
            <label class="form-label">Note</label>
            <div id="note-toolbar" class="mb-2">
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
              </span>
              <span class="ql-formats">
                <select class="ql-color"></select>
                <select class="ql-background"></select>
              </span>
              <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
              </span>
            </div>
            <div id="note-editor" style="height: 150px;"></div>
            <input type="hidden" name="note" id="note-input">
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Income</button>
          <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
